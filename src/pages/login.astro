---
import PublicLayout from '../layouts/PublicLayout.astro';
import { getSessionFromRequest } from '../lib/auth';

// Redirect if already logged in
const session = getSessionFromRequest(Astro.request);
if (session) {
  return Astro.redirect('/dashboard');
}

const redirect = Astro.url.searchParams.get('redirect') ?? '/dashboard';
const errorParam = Astro.url.searchParams.get('error');
---

<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <title>Login | MBG Monitor</title>
    <style>
      body { font-family: 'Inter', ui-sans-serif, system-ui, sans-serif; }
    </style>
  </head>
  <body class="min-h-screen bg-cream-50 flex antialiased">
    <!-- Left decorative panel (hidden on mobile) -->
    <div class="hidden lg:flex lg:w-1/2 bg-gradient-to-br from-brand-900 via-brand-800 to-brand-950 relative overflow-hidden items-center justify-center p-12">
      <div class="absolute inset-0">
        <div class="absolute top-0 right-0 w-96 h-96 bg-brand-400/10 rounded-full blur-3xl -translate-y-1/3 translate-x-1/3"></div>
        <div class="absolute bottom-0 left-0 w-80 h-80 bg-amber-500/5 rounded-full blur-3xl translate-y-1/3 -translate-x-1/3"></div>
      </div>
      <div class="relative text-center max-w-md">
        <div class="w-16 h-16 bg-white/10 backdrop-blur-sm rounded-2xl flex items-center justify-center mx-auto mb-8 shadow-lg border border-white/10">
          <svg class="w-8 h-8 text-brand-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
          </svg>
        </div>
        <h2 class="text-3xl font-extrabold text-white mb-4 tracking-tight">MBG Monitor</h2>
        <p class="text-brand-200 leading-relaxed">
          Sistem monitoring Program Makan Bergizi Gratis berbasis AI untuk estimasi nilai gizi makanan secara otomatis.
        </p>
        <div class="mt-10 grid grid-cols-3 gap-4">
          <div class="bg-white/10 rounded-xl p-4 border border-white/10 backdrop-blur-sm">
            <p class="text-xl font-bold text-white">AI</p>
            <p class="text-xs text-brand-200 mt-1">RT-DETR</p>
          </div>
          <div class="bg-white/10 rounded-xl p-4 border border-white/20 backdrop-blur-sm">
            <p class="text-xl font-bold text-white">92%</p>
            <p class="text-xs text-brand-200 mt-1">mAP@50</p>
          </div>
          <div class="bg-white/10 rounded-xl p-4 border border-white/20 backdrop-blur-sm">
            <p class="text-xl font-bold text-white">4+</p>
            <p class="text-xs text-brand-200 mt-1">Nutrisi</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Right login form -->
    <div class="flex-1 flex items-center justify-center px-6 py-12">
      <div class="w-full max-w-sm">
        <!-- Mobile logo -->
        <div class="flex flex-col items-center mb-10 lg:hidden">
          <div class="w-12 h-12 bg-gradient-to-br from-brand-500 to-brand-700 rounded-xl flex items-center justify-center shadow-soft mb-4">
            <svg class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
            </svg>
          </div>
          <h1 class="text-xl font-bold text-brand-900 tracking-tight">MBG Monitor</h1>
        </div>

        <!-- Desktop heading -->
        <div class="hidden lg:block mb-10">
          <h1 class="text-2xl font-extrabold text-brand-900 tracking-tight">Selamat Datang</h1>
          <p class="text-brand-500 text-sm mt-2">Masuk ke dashboard untuk mengelola data.</p>
        </div>

        {errorParam === 'invalid' && (
          <div class="bg-red-50 border border-red-100 text-red-600 text-sm px-4 py-3.5 rounded-xl mb-6 flex items-center gap-3">
            <svg class="w-5 h-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
            </svg>
            <span>Username atau password salah.</span>
          </div>
        )}

        {errorParam === 'server' && (
          <div class="bg-red-50 border border-red-100 text-red-600 text-sm px-4 py-3.5 rounded-xl mb-6 flex items-center gap-3">
            <svg class="w-5 h-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" />
            </svg>
            <span>Terdapat kesalahan server. Silakan coba lagi.</span>
          </div>
        )}

        <form method="POST" action="/api/auth/login" id="login-form" class="space-y-5">
          <input type="hidden" name="redirect" value={redirect} />

          <div>
            <label for="username" class="block text-[13px] font-semibold text-brand-800 mb-2">
              Username
            </label>
            <input
              type="text"
              id="username"
              name="username"
              required
              autocomplete="username"
              placeholder="Masukkan username"
              class="w-full px-4 py-3 bg-white border border-brand-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 text-brand-900 text-sm transition-all placeholder:text-brand-400"
            />
          </div>

          <div>
            <label for="password" class="block text-[13px] font-semibold text-brand-800 mb-2">
              Password
            </label>
            <div class="relative">
              <input
                type="password"
                id="password"
                name="password"
                required
                autocomplete="current-password"
                placeholder="Masukkan password"
                class="w-full px-4 py-3 bg-white border border-brand-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500/30 focus:border-brand-500 text-brand-900 text-sm transition-all placeholder:text-brand-400 pr-12"
              />
              <button
                type="button"
                id="toggle-password"
                class="absolute right-3 top-1/2 -translate-y-1/2 text-brand-400 hover:text-brand-600 transition p-1"
              >
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </button>
            </div>
          </div>

          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-brand-600 text-white font-semibold py-3.5 rounded-xl hover:bg-brand-700 transition-all shadow-soft hover:shadow-glow-brand flex items-center justify-center gap-2.5"
          >
            <span id="submit-icon">
              <svg class="w-4.5 h-4.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
              </svg>
            </span>
            <span id="submit-text">Masuk</span>
          </button>
        </form>

        <div class="mt-8 text-center">
          <a href="/" class="text-sm text-brand-500 hover:text-brand-700 transition-colors font-medium flex items-center justify-center gap-1.5">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Kembali ke Beranda
          </a>
        </div>

        <p class="text-center text-xs text-brand-400 mt-10">
          MBG Monitoring System &copy; 2026
        </p>
      </div>
    </div>

    <script>
      const toggleBtn = document.getElementById('toggle-password');
      const passwordInput = document.getElementById('password') as HTMLInputElement;
      toggleBtn?.addEventListener('click', () => {
        passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password';
      });

      const form = document.getElementById('login-form') as HTMLFormElement;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      const submitIcon = document.getElementById('submit-icon')!;
      const submitText = document.getElementById('submit-text')!;

      form.addEventListener('submit', () => {
        submitBtn.disabled = true;
        submitIcon.innerHTML = '<svg class="animate-spin w-4.5 h-4.5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4l3-3-3-3v4a8 8 0 00-8 8h4l-3 3-3-3h4z"/></svg>';
        submitText.textContent = 'Sedang masuk...';
      });
    </script>
  </body>
</html>
