---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
---

<DashboardLayout title="Deteksi Menu" activeNav="detect">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <div class="w-10 h-10 rounded-xl bg-brand-50 flex items-center justify-center">
          <svg class="w-5 h-5 text-brand-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 00-1.134-.175 2.31 2.31 0 01-1.64-1.055l-.822-1.316a2.192 2.192 0 00-1.736-1.039 48.774 48.774 0 00-5.232 0 2.192 2.192 0 00-1.736 1.039l-.821 1.316z"/><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0zM18.75 10.5h.008v.008h-.008V10.5z"/></svg>
        </div>
        <div>
          <h2 class="text-xl font-bold text-brand-900">Deteksi Nutrisi Menu</h2>
          <p class="text-emerald-700 text-sm">Upload foto menu untuk deteksi otomatis dan estimasi nutrisi</p>
        </div>
      </div>
    </div>

    <!-- Upload & Detect Panel -->
    <div class="bg-white rounded-2xl border border-emerald-200 shadow-soft p-6 mb-6">
      <div
        id="drop-zone"
        class="border-2 border-dashed border-emerald-300 rounded-2xl p-10 text-center hover:border-emerald-500 hover:bg-emerald-50 transition-all duration-300 cursor-pointer group"
      >
        <div id="upload-prompt">
          <div class="w-16 h-16 rounded-2xl bg-brand-50 group-hover:bg-brand-100 flex items-center justify-center mx-auto mb-5 transition-colors duration-300">
            <svg class="w-8 h-8 text-brand-300 group-hover:text-brand-500 transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
          </div>
          <p class="font-semibold text-brand-900 text-lg">Seret & Lepas foto menu di sini</p>
          <p class="text-sm text-emerald-700 mt-1 mb-5">atau klik untuk memilih file dari perangkat</p>
          <label class="inline-flex items-center gap-2 bg-brand-600 text-white px-6 py-2.5 rounded-xl cursor-pointer hover:bg-brand-700 transition-all duration-200 font-semibold text-sm shadow-sm hover:shadow-md">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.41a2.25 2.25 0 013.182 0l2.909 2.91m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
            Pilih Foto
            <input id="image-input" type="file" accept="image/*" class="sr-only" />
          </label>
          <p class="text-xs text-emerald-400 mt-4">Format: JPG, PNG, WebP — Maks 10 MB</p>
        </div>

        <div id="preview-area" class="hidden">
          <div class="relative inline-block">
            <img id="preview-img" src="" alt="Preview" class="max-h-72 mx-auto rounded-xl object-contain shadow-soft" />
            <button id="clear-btn" class="absolute -top-2 -right-2 w-8 h-8 bg-white border border-surface-200 text-surface-500 rounded-full hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all duration-200 shadow-soft flex items-center justify-center">
              <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <p id="file-info" class="text-sm text-surface-400 mt-3"></p>
        </div>
      </div>

      <!-- Notes -->
      <div class="mt-5">
        <label for="notes" class="block text-sm font-medium text-brand-700 mb-2">Catatan (opsional)</label>
        <textarea
          id="notes"
          rows="2"
          placeholder="Contoh: Makan siang siswi kelas 4A SDN 01..."
          class="w-full px-4 py-3 border border-emerald-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500/30 focus:border-emerald-400 text-slate-900 resize-none placeholder:text-slate-400 transition-all duration-200"
        ></textarea>
      </div>

      <!-- Action buttons -->
      <div class="mt-5 flex flex-col sm:flex-row gap-3">
        <button
          id="detect-btn"
          disabled
          class="flex-1 sm:flex-none bg-brand-600 text-white font-semibold px-8 py-3 rounded-xl disabled:opacity-40 disabled:cursor-not-allowed hover:bg-brand-700 transition-all duration-200 flex items-center justify-center gap-2 shadow-sm hover:shadow-md"
        >
          <span id="btn-icon"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg></span>
          <span id="btn-text">Deteksi & Simpan</span>
        </button>
        <button
          id="preview-btn"
          disabled
          class="flex-1 sm:flex-none bg-slate-100 text-emerald-800 font-semibold px-6 py-3 rounded-xl disabled:opacity-40 disabled:cursor-not-allowed hover:bg-slate-200 transition-all duration-200 flex items-center justify-center gap-2 border border-emerald-200"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          Preview Saja
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden bg-white border border-emerald-200 rounded-2xl p-5 items-center gap-4 mb-6 shadow-soft" data-display="flex">
      <div class="w-10 h-10 rounded-xl bg-brand-50 flex items-center justify-center shrink-0">
        <svg class="animate-spin w-5 h-5 text-brand-600" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
      </div>
      <div>
        <p class="text-surface-800 font-semibold text-sm" id="loading-msg">Menjalankan deteksi RT-DETR…</p>
        <p class="text-surface-400 text-xs mt-0.5">Proses ini membutuhkan beberapa detik</p>
      </div>
    </div>

    <!-- Error -->
    <div id="error-box" class="hidden bg-white border border-red-200 rounded-2xl p-5 mb-6 shadow-soft">
      <div class="flex items-start gap-3">
        <div class="w-8 h-8 rounded-lg bg-red-50 flex items-center justify-center shrink-0 mt-0.5">
          <svg class="w-4 h-4 text-red-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/></svg>
        </div>
        <div>
          <p class="text-red-800 font-semibold text-sm">Terjadi Kesalahan</p>
          <p id="error-msg" class="text-red-600 text-sm mt-0.5"></p>
        </div>
      </div>
    </div>

    <!-- Success notification -->
    <div id="success-box" class="hidden bg-white border border-emerald-300 rounded-2xl p-5 mb-6 items-center gap-3 shadow-soft" data-display="flex">
      <div class="w-8 h-8 rounded-lg bg-brand-50 flex items-center justify-center shrink-0">
        <svg class="w-4 h-4 text-brand-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      </div>
      <div>
        <p class="text-surface-800 font-semibold text-sm">Deteksi berhasil disimpan!</p>
        <p class="text-surface-400 text-xs mt-0.5">Hasil telah tersimpan ke database. <a id="history-link" href="/dashboard/history" class="text-brand-600 hover:text-brand-700 font-medium transition-colors">Lihat riwayat →</a></p>
      </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-6 animate-fade-in">
      <!-- Annotated image -->
      <div class="bg-white rounded-2xl border border-emerald-200 shadow-soft p-6">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-8 h-8 rounded-lg bg-indigo-50 flex items-center justify-center">
            <svg class="w-4 h-4 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.41a2.25 2.25 0 013.182 0l2.909 2.91m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
          </div>
          <h3 class="font-semibold text-brand-900">Hasil Anotasi</h3>
        </div>
        <img id="annotated-img" src="" alt="Annotated result" class="w-full rounded-xl border border-emerald-200 max-h-96 object-contain bg-slate-50" />
      </div>

      <!-- Nutrition totals -->
      <div class="bg-white rounded-2xl border border-emerald-200 shadow-soft p-6">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center">
            <svg class="w-4 h-4 text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6"/></svg>
          </div>
          <h3 class="font-semibold text-brand-900">Total Estimasi Nilai Gizi</h3>
        </div>
        <div id="nutrition-grid" class="grid grid-cols-2 sm:grid-cols-5 gap-3"></div>
      </div>

      <!-- Detection summary -->
      <div class="bg-white rounded-2xl border border-emerald-200 shadow-soft overflow-hidden">
        <div class="px-6 py-4 border-b border-emerald-200 flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center">
            <svg class="w-4 h-4 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM3.75 12h.007v.008H3.75V12zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-.375 5.25h.007v.008H3.75v-.008zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
          </div>
          <h3 class="font-semibold text-brand-900">Item Menu Terdeteksi</h3>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-emerald-50">
              <tr>
                <th class="px-5 py-3 text-left text-xs font-medium text-emerald-700 uppercase tracking-wider">Menu</th>
                <th class="px-5 py-3 text-left text-xs font-medium text-emerald-700 uppercase tracking-wider">Database</th>
                <th class="px-5 py-3 text-right text-xs font-medium text-emerald-700 uppercase tracking-wider">Berat</th>
                <th class="px-5 py-3 text-right text-xs font-medium text-emerald-700 uppercase tracking-wider">Kalori</th>
                <th class="px-5 py-3 text-right text-xs font-medium text-emerald-700 uppercase tracking-wider">Protein</th>
                <th class="px-5 py-3 text-right text-xs font-medium text-emerald-700 uppercase tracking-wider">Karbo</th>
                <th class="px-5 py-3 text-right text-xs font-medium text-emerald-700 uppercase tracking-wider">Lemak</th>
                <th class="px-5 py-3 text-right text-xs font-medium text-emerald-700 uppercase tracking-wider">Serat</th>
              </tr>
            </thead>
            <tbody id="items-tbody" class="divide-y divide-surface-100 bg-white"></tbody>
          </table>
        </div>
      </div>

      <!-- Portion reference card (Porsi Besar vs Porsi Kecil) -->
      <div id="portion-ref" class="hidden bg-white rounded-2xl border border-emerald-200 shadow-soft overflow-hidden">
        <div class="px-6 py-4 border-b border-emerald-200 flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-lg bg-violet-50 flex items-center justify-center">
              <svg class="w-4 h-4 text-violet-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v17.25m0 0c-1.472 0-2.882.265-4.185.75M12 20.25c1.472 0 2.882.265 4.185.75M18.75 4.97A48.416 48.416 0 0012 4.5c-2.291 0-4.545.16-6.75.47m13.5 0c1.01.143 2.01.317 3 .52m-3-.52l2.62 10.726c.122.499-.106 1.028-.589 1.202a5.988 5.988 0 01-2.031.352 5.988 5.988 0 01-2.031-.352c-.483-.174-.711-.703-.59-1.202L18.75 4.971zm-16.5.52c.99-.203 1.99-.377 3-.52m0 0l2.62 10.726c.122.499-.106 1.028-.589 1.202a5.989 5.989 0 01-2.031.352 5.989 5.989 0 01-2.031-.352c-.483-.174-.711-.703-.59-1.202L5.25 4.971z"/></svg>
            </div>
            <div>
              <h3 class="font-semibold text-brand-900">Referensi Porsi Menu Harian</h3>
              <p id="portion-menu-name" class="text-xs text-emerald-600 font-medium"></p>
            </div>
          </div>
          <span id="portion-match-badge" class="text-xs font-semibold px-3 py-1 rounded-full"></span>
        </div>

        <div class="p-6">
          <!-- Menu items list -->
          <div id="portion-menu-items" class="mb-5 flex flex-wrap gap-1.5"></div>

          <!-- Portion comparison grid -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-5">
            <!-- Porsi Besar -->
            <div id="porsi-besar-card" class="rounded-xl border-2 p-4 transition-all duration-200">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <div class="w-7 h-7 rounded-lg bg-orange-100 flex items-center justify-center">
                    <svg class="w-4 h-4 text-orange-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l7.5-7.5 7.5 7.5m-15 6l7.5-7.5 7.5 7.5"/></svg>
                  </div>
                  <div>
                    <h4 class="font-bold text-surface-800 text-sm">Porsi Besar</h4>
                    <p class="text-xs text-surface-400">SMP / SMA & Dewasa</p>
                  </div>
                </div>
                <span id="porsi-besar-badge" class="hidden text-xs font-bold px-2.5 py-0.5 rounded-full bg-orange-100 text-orange-700">Terdekat</span>
              </div>
              <div class="space-y-2" id="porsi-besar-nutrients"></div>
            </div>

            <!-- Porsi Kecil -->
            <div id="porsi-kecil-card" class="rounded-xl border-2 p-4 transition-all duration-200">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <div class="w-7 h-7 rounded-lg bg-sky-100 flex items-center justify-center">
                    <svg class="w-4 h-4 text-sky-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 5.25l-7.5 7.5-7.5-7.5m15 6l-7.5 7.5-7.5-7.5"/></svg>
                  </div>
                  <div>
                    <h4 class="font-bold text-surface-800 text-sm">Porsi Kecil</h4>
                    <p class="text-xs text-surface-400">TK / SD & Anak-anak</p>
                  </div>
                </div>
                <span id="porsi-kecil-badge" class="hidden text-xs font-bold px-2.5 py-0.5 rounded-full bg-sky-100 text-sky-700">Terdekat</span>
              </div>
              <div class="space-y-2" id="porsi-kecil-nutrients"></div>
            </div>
          </div>

          <!-- Deviation indicator -->
          <div id="portion-deviation" class="rounded-xl bg-surface-50 p-4 flex items-center gap-3">
            <div id="deviation-icon" class="w-9 h-9 rounded-lg flex items-center justify-center shrink-0"></div>
            <div>
              <p id="deviation-text" class="text-sm font-semibold text-surface-800"></p>
              <p id="deviation-detail" class="text-xs text-surface-400 mt-0.5"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<script>
  const imageInput = document.getElementById('image-input') as HTMLInputElement;
  const dropZone = document.getElementById('drop-zone')!;
  const uploadPrompt = document.getElementById('upload-prompt')!;
  const previewArea = document.getElementById('preview-area')!;
  const previewImg = document.getElementById('preview-img') as HTMLImageElement;
  const clearBtn = document.getElementById('clear-btn')!;
  const fileInfo = document.getElementById('file-info')!;
  const detectBtn = document.getElementById('detect-btn') as HTMLButtonElement;
  const previewBtn = document.getElementById('preview-btn') as HTMLButtonElement;
  const btnIcon = document.getElementById('btn-icon')!;
  const btnText = document.getElementById('btn-text')!;
  const notesInput = document.getElementById('notes') as HTMLTextAreaElement;
  const loading = document.getElementById('loading')!;
  const loadingMsg = document.getElementById('loading-msg')!;
  const errorBox = document.getElementById('error-box')!;
  const errorMsg = document.getElementById('error-msg')!;
  const successBox = document.getElementById('success-box')!;
  const resultsDiv = document.getElementById('results')!;
  const annotatedImg = document.getElementById('annotated-img') as HTMLImageElement;
  const nutritionGrid = document.getElementById('nutrition-grid')!;
  const itemsTbody = document.getElementById('items-tbody')!;
  const portionRef = document.getElementById('portion-ref')!;

  let selectedFile: File | null = null;

  function showFile(file: File) {
    selectedFile = file;
    previewImg.src = URL.createObjectURL(file);
    fileInfo.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
    uploadPrompt.classList.add('hidden');
    previewArea.classList.remove('hidden');
    detectBtn.disabled = false;
    previewBtn.disabled = false;
    hideAll();
  }

  function clearFile() {
    selectedFile = null;
    previewImg.src = '';
    previewArea.classList.add('hidden');
    uploadPrompt.classList.remove('hidden');
    detectBtn.disabled = true;
    previewBtn.disabled = true;
    imageInput.value = '';
    hideAll();
  }

  function show(el: HTMLElement) {
    el.classList.remove('hidden');
    const display = el.dataset.display;
    if (display) el.style.display = display;
  }

  function hide(el: HTMLElement) {
    el.classList.add('hidden');
    el.style.display = '';
  }

  function hideAll() {
    hide(loading);
    hide(errorBox);
    hide(successBox);
    resultsDiv.classList.add('hidden');
    portionRef.classList.add('hidden');
  }

  function showError(msg: string) {
    errorBox.classList.remove('hidden');
    errorMsg.textContent = msg;
    hide(loading);
  }

  imageInput.addEventListener('change', () => { if (imageInput.files?.[0]) showFile(imageInput.files[0]); });
  clearBtn.addEventListener('click', clearFile);

  dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-emerald-500', 'bg-emerald-50'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-emerald-500', 'bg-emerald-50'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-emerald-500', 'bg-emerald-50');
    const f = e.dataTransfer?.files?.[0];
    if (f && f.type.startsWith('image/')) showFile(f);
  });

  // Preview only
  previewBtn.addEventListener('click', async () => {
    if (!selectedFile) return;
    hideAll();
    show(loading);
    loadingMsg.textContent = 'Mengambil preview anotasi…';
    try {
      const fd = new FormData();
      fd.append('image', selectedFile);
      const res = await fetch('/api/detect?preview=true', { method: 'POST', body: fd });
      if (!res.ok) throw new Error(`Error ${res.status}`);
      const blob = await res.blob();
      annotatedImg.src = URL.createObjectURL(blob);
      nutritionGrid.innerHTML = '';
      itemsTbody.innerHTML = `<tr><td colspan="8" class="px-5 py-6 text-center text-surface-300 text-sm italic">Preview saja — tidak tersimpan</td></tr>`;
      resultsDiv.classList.remove('hidden');
    } catch (e) {
      showError(e instanceof Error ? e.message : 'Gagal mengambil preview');
    } finally {
      hide(loading);
    }
  });

  const spinnerSvg = `<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg>`;
  const detectSvg = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.023-.501.05-.75.082m.75-.082a24.301 24.301 0 014.5 0m0 0v5.714c0 .597.237 1.17.659 1.591L19.8 15.3M14.25 3.104c.251.023.501.05.75.082M19.8 15.3l-1.57.393A9.065 9.065 0 0112 15a9.065 9.065 0 00-6.23.693L5 14.5m14.8.8l1.402 1.402c1.232 1.232.65 3.318-1.067 3.611A48.309 48.309 0 0112 21c-2.773 0-5.491-.235-8.135-.687-1.718-.293-2.3-2.379-1.067-3.61L5 14.5"/></svg>`;

  // Detect & save
  detectBtn.addEventListener('click', async () => {
    if (!selectedFile) return;
    hideAll();
    show(loading);
    loadingMsg.textContent = 'Menjalankan deteksi RT-DETR…';
    detectBtn.disabled = true;
    btnIcon.innerHTML = spinnerSvg;
    btnText.textContent = 'Mendeteksi…';

    try {
      const fd = new FormData();
      fd.append('image', selectedFile);
      const res = await fetch('/api/detect?save=true', { method: 'POST', body: fd });
      if (!res.ok) throw new Error(`Server error ${res.status}`);
      const data = await res.json();
      if (!data.success) throw new Error(data.error ?? 'Detection failed');

      loadingMsg.textContent = 'Menyimpan gambar ke storage…';

      // Use annotated image URL from Supabase if available, otherwise fallback to preview API
      if (data.annotated_image_url) {
        annotatedImg.src = data.annotated_image_url;
      } else {
        const fd2 = new FormData();
        fd2.append('image', selectedFile);
        const prevRes = await fetch('/api/detect/preview', { method: 'POST', body: fd2 });
        if (prevRes.ok) annotatedImg.src = URL.createObjectURL(await prevRes.blob());
      }

      // Nutrition totals
      const n = data.nutrition_totals ?? {};
      const nutritionCards = [
        { label: 'Kalori', value: `${n.calories ?? 0}`, unit: 'kkal', color: 'bg-amber-50 text-amber-700 border-amber-100' },
        { label: 'Protein', value: `${n.protein ?? 0}`, unit: 'g', color: 'bg-blue-50 text-blue-700 border-blue-100' },
        { label: 'Karbohidrat', value: `${n.carbohydrates ?? 0}`, unit: 'g', color: 'bg-purple-50 text-purple-700 border-purple-100' },
        { label: 'Lemak', value: `${n.fat ?? 0}`, unit: 'g', color: 'bg-rose-50 text-rose-700 border-rose-100' },
        { label: 'Serat', value: `${n.fiber ?? 0}`, unit: 'g', color: 'bg-teal-50 text-teal-700 border-teal-100' },
      ];
      nutritionGrid.innerHTML = nutritionCards.map(c => `
        <div class="border rounded-xl p-4 text-center ${c.color}">
          <p class="text-2xl font-bold">${c.value}<span class="text-sm font-normal ml-0.5">${c.unit}</span></p>
          <p class="text-xs mt-1 opacity-70 font-medium">${c.label}</p>
        </div>
      `).join('');

      // Items table — merge duplicates
      type DItem = { food_name: string; matched_food_name: string | null; confidence: number; estimated_weight_gram: number; calories: number; protein: number; carbohydrates: number; fat: number; fiber: number };
      const rawItems: DItem[] = data.nutrition_items ?? [];
      interface MergedDItem extends DItem { qty: number; }
      const mergedMap = new Map<string, MergedDItem>();
      for (const item of rawItems) {
        const key = item.food_name.toLowerCase();
        if (mergedMap.has(key)) {
          const m = mergedMap.get(key)!;
          m.qty += 1;
          m.confidence = (m.confidence * (m.qty - 1) + item.confidence) / m.qty;
          m.estimated_weight_gram += item.estimated_weight_gram;
          m.calories += item.calories;
          m.protein += item.protein;
          m.carbohydrates += item.carbohydrates;
          m.fat += item.fat;
          m.fiber += item.fiber;
        } else {
          mergedMap.set(key, { ...item, qty: 1 });
        }
      }
      const items = Array.from(mergedMap.values());
      if (items.length === 0) {
        itemsTbody.innerHTML = `<tr><td colspan="8" class="px-5 py-8 text-center text-surface-300">Tidak ada item terdeteksi dalam database nutrisi.</td></tr>`;
      } else {
        itemsTbody.innerHTML = items.map(item => `
          <tr class="hover:bg-surface-50 transition-colors">
            <td class="px-5 py-3.5 font-semibold text-surface-900 capitalize">${item.food_name}</td>
            <td class="px-5 py-3.5 text-xs">${item.matched_food_name ? `<span class="inline-flex items-center gap-1 text-brand-700 font-medium"><svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>${item.matched_food_name}</span>` : '<span class="text-surface-300">Tidak ditemukan</span>'}</td>
            <td class="px-5 py-3.5 text-right text-surface-600">${parseFloat(Number(item.estimated_weight_gram).toFixed(2))}g</td>
            <td class="px-5 py-3.5 text-right font-semibold text-amber-600">${parseFloat(Number(item.calories).toFixed(2))}</td>
            <td class="px-5 py-3.5 text-right text-surface-600">${parseFloat(Number(item.protein).toFixed(2))}g</td>
            <td class="px-5 py-3.5 text-right text-surface-600">${parseFloat(Number(item.carbohydrates).toFixed(2))}g</td>
            <td class="px-5 py-3.5 text-right text-surface-600">${parseFloat(Number(item.fat).toFixed(2))}g</td>
            <td class="px-5 py-3.5 text-right text-surface-600">${parseFloat(Number(item.fiber).toFixed(2))}g</td>
          </tr>
        `).join('');
      }

      resultsDiv.classList.remove('hidden');
      if (data.detection_id) show(successBox);

      // Render portion reference card if a daily menu matched
      renderPortionRef(data.matched_daily_menu, data.nutrition_totals);
    } catch (e) {
      showError(e instanceof Error ? e.message : 'Deteksi gagal. Pastikan API Python berjalan.');
    } finally {
      hide(loading);
      detectBtn.disabled = false;
      btnIcon.innerHTML = detectSvg;
      btnText.textContent = 'Deteksi & Simpan';
    }
  });

  // ─── Portion Reference Card ────────────────────────────────────────────────
  function renderPortionRef(menu: any, totals: any) {
    if (!menu) {
      portionRef.classList.add('hidden');
      return;
    }

    portionRef.classList.remove('hidden');

    // Menu name & match badge
    document.getElementById('portion-menu-name')!.textContent =
      `${menu.menuName} — Kecocokan ${Math.round(menu.matchScore * 100)}%`;

    const matchBadge = document.getElementById('portion-match-badge')!;
    if (menu.matchScore >= 0.8) {
      matchBadge.textContent = `${Math.round(menu.matchScore * 100)}% cocok`;
      matchBadge.className = 'text-xs font-semibold px-3 py-1 rounded-full bg-brand-50 text-brand-700';
    } else {
      matchBadge.textContent = `${Math.round(menu.matchScore * 100)}% cocok`;
      matchBadge.className = 'text-xs font-semibold px-3 py-1 rounded-full bg-amber-50 text-amber-700';
    }

    // Menu items pills
    const itemsContainer = document.getElementById('portion-menu-items')!;
    const detectedLower = (totals ? [] : []).concat(
      menu.menuItems.map((n: string) => n.toLowerCase())
    );
    itemsContainer.innerHTML = menu.menuItems.map((item: string) =>
      `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium bg-violet-50 text-violet-700 border border-violet-100">
        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75"/></svg>
        ${item}
      </span>`
    ).join('');

    // Nutrient comparison rows builder
    function buildNutrientRows(portion: any, estimatedTotals: any): string {
      const nutrients = [
        { label: 'Kalori', key: 'calories', unit: 'kkal', color: 'amber' },
        { label: 'Protein', key: 'protein', unit: 'g', color: 'blue' },
        { label: 'Karbohidrat', key: 'carbohydrates', unit: 'g', color: 'purple' },
        { label: 'Lemak', key: 'fat', unit: 'g', color: 'rose' },
        { label: 'Serat', key: 'fiber', unit: 'g', color: 'teal' },
      ];

      return nutrients.map(n => {
        const ref = portion[n.key] ?? 0;
        const est = estimatedTotals?.[n.key] ?? 0;
        const ratio = ref > 0 ? (est / ref) * 100 : 0;
        const pct = Math.min(ratio, 100);
        const barColor = ratio > 120 ? 'bg-rose-400' : ratio >= 80 ? 'bg-emerald-400' : 'bg-amber-400';

        return `
          <div class="flex items-center gap-3">
            <span class="text-xs font-medium text-surface-500 w-20 shrink-0">${n.label}</span>
            <div class="flex-1 h-1.5 bg-surface-100 rounded-full overflow-hidden">
              <div class="${barColor} h-full rounded-full transition-all duration-500" style="width: ${Math.min(pct, 100).toFixed(0)}%"></div>
            </div>
            <span class="text-xs font-bold text-surface-700 w-16 text-right">${ref} ${n.unit}</span>
          </div>`;
      }).join('');
    }

    // Populate both portion cards
    document.getElementById('porsi-besar-nutrients')!.innerHTML =
      buildNutrientRows(menu.porsi_besar, totals);
    document.getElementById('porsi-kecil-nutrients')!.innerHTML =
      buildNutrientRows(menu.porsi_kecil, totals);

    // Highlight closest portion
    const besarCard = document.getElementById('porsi-besar-card')!;
    const kecilCard = document.getElementById('porsi-kecil-card')!;
    const besarBadge = document.getElementById('porsi-besar-badge')!;
    const kecilBadge = document.getElementById('porsi-kecil-badge')!;

    if (menu.closestPortion === 'porsi_besar') {
      besarCard.className = 'rounded-xl border-2 border-orange-300 bg-orange-50/30 p-4 transition-all duration-200';
      kecilCard.className = 'rounded-xl border-2 border-surface-200 p-4 transition-all duration-200';
      besarBadge.classList.remove('hidden');
      kecilBadge.classList.add('hidden');
    } else {
      kecilCard.className = 'rounded-xl border-2 border-sky-300 bg-sky-50/30 p-4 transition-all duration-200';
      besarCard.className = 'rounded-xl border-2 border-surface-200 p-4 transition-all duration-200';
      kecilBadge.classList.remove('hidden');
      besarBadge.classList.add('hidden');
    }

    // Deviation indicator
    const devIcon = document.getElementById('deviation-icon')!;
    const devText = document.getElementById('deviation-text')!;
    const devDetail = document.getElementById('deviation-detail')!;
    const absDeviation = Math.abs(menu.calorieDeviation);

    if (absDeviation <= 10) {
      devIcon.className = 'w-9 h-9 rounded-lg flex items-center justify-center shrink-0 bg-brand-50';
      devIcon.innerHTML = '<svg class="w-5 h-5 text-brand-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
      devText.textContent = `Sesuai standar ${menu.portionLabel}`;
      devDetail.textContent = `Deviasi kalori hanya ${absDeviation.toFixed(1)}% dari referensi ${menu.portionLabel}. Menu ini memenuhi standar gizi.`;
    } else if (menu.calorieDeviation > 0) {
      devIcon.className = 'w-9 h-9 rounded-lg flex items-center justify-center shrink-0 bg-amber-50';
      devIcon.innerHTML = '<svg class="w-5 h-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18"/></svg>';
      devText.textContent = `Kalori ${absDeviation.toFixed(1)}% di atas ${menu.portionLabel}`;
      devDetail.textContent = `Estimasi kalori terdeteksi lebih tinggi dari standar referensi ${menu.portionLabel}. Porsi makanan mungkin lebih besar dari standar.`;
    } else {
      devIcon.className = 'w-9 h-9 rounded-lg flex items-center justify-center shrink-0 bg-sky-50';
      devIcon.innerHTML = '<svg class="w-5 h-5 text-sky-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3"/></svg>';
      devText.textContent = `Kalori ${absDeviation.toFixed(1)}% di bawah ${menu.portionLabel}`;
      devDetail.textContent = `Estimasi kalori terdeteksi lebih rendah dari standar referensi ${menu.portionLabel}. Porsi makanan mungkin lebih kecil dari standar.`;
    }
  }
</script>
