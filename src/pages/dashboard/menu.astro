---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { db } from '../../db/db';
import { dailyMenus } from '../../db/schema';
import { asc } from 'drizzle-orm';

// Fetch all daily menus
interface MenuRow {
  menuName: string;
  menuItems: string[];
  imageUrl: string | null;
  porsi_besar: { calories: number; protein: number; carbohydrates: number; fat: number; fiber: number };
  porsi_kecil: { calories: number; protein: number; carbohydrates: number; fat: number; fiber: number };
}

let menus: MenuRow[] = [];

try {
  const rows = await db.select().from(dailyMenus).orderBy(asc(dailyMenus.menuName));

  const grouped = new Map<string, {
    menuItems: string[];
    imageUrl: string | null;
    porsi_besar: { calories: number; protein: number; carbohydrates: number; fat: number; fiber: number };
    porsi_kecil: { calories: number; protein: number; carbohydrates: number; fat: number; fiber: number };
  }>();

  for (const row of rows) {
    const key = row.menuName;
    if (!grouped.has(key)) {
      grouped.set(key, {
        menuItems: [],
        imageUrl: null,
        porsi_besar: { calories: 0, protein: 0, carbohydrates: 0, fat: 0, fiber: 0 },
        porsi_kecil: { calories: 0, protein: 0, carbohydrates: 0, fat: 0, fiber: 0 },
      });
    }
    const entry = grouped.get(key)!;

    try {
      const items = JSON.parse(row.menuItems);
      if (Array.isArray(items) && items.length > entry.menuItems.length) {
        entry.menuItems = items;
      }
    } catch {}

    if (row.imageUrl && !entry.imageUrl) {
      entry.imageUrl = row.imageUrl;
    }

    const nutrition = {
      calories: parseFloat(String(row.calories)) || 0,
      protein: parseFloat(String(row.protein)) || 0,
      carbohydrates: parseFloat(String(row.carbohydrates)) || 0,
      fat: parseFloat(String(row.fat)) || 0,
      fiber: parseFloat(String(row.fiber)) || 0,
    };

    if (row.portionSize === 'porsi_besar') {
      entry.porsi_besar = nutrition;
    } else {
      entry.porsi_kecil = nutrition;
    }
  }

  menus = Array.from(grouped.entries())
    .sort((a, b) => {
      const numA = parseInt(a[0].replace(/\D/g, '')) || 0;
      const numB = parseInt(b[0].replace(/\D/g, '')) || 0;
      return numA - numB;
    })
    .map(([menuName, data]) => ({ menuName, ...data }));
} catch (e) {
  console.error('Error fetching daily menus:', e);
}

const menusJson = JSON.stringify(menus);
---

<DashboardLayout title="Daftar Menu MBG" activeNav="menu">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-xl font-extrabold text-brand-900 tracking-tight">Daftar Menu MBG</h1>
      <p class="text-sm text-emerald-700 mt-1">Referensi menu harian beserta kandungan nutrisi per porsi</p>
    </div>
    <div class="flex items-center gap-2">
      <span class="text-xs font-medium text-emerald-700 bg-emerald-50 px-3 py-1.5 rounded-lg">{menus.length} Menu</span>
    </div>
  </div>

  <!-- Table -->
  <div class="bg-white rounded-2xl border border-emerald-200 shadow-soft overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm" id="menu-table">
        <thead class="bg-emerald-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-emerald-700 uppercase tracking-wider w-12">No</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-emerald-700 uppercase tracking-wider w-24">Foto</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-emerald-700 uppercase tracking-wider">Menu</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-emerald-700 uppercase tracking-wider">Daftar Item</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-emerald-700 uppercase tracking-wider" colspan="2">Kalori</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-emerald-700 uppercase tracking-wider" colspan="2">Protein</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-emerald-700 uppercase tracking-wider" colspan="2">Karbo</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-emerald-700 uppercase tracking-wider" colspan="2">Lemak</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-emerald-700 uppercase tracking-wider" colspan="2">Serat</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-emerald-700 uppercase tracking-wider w-16">Aksi</th>
          </tr>
          <tr class="bg-emerald-50/60">
            <th class="px-4 py-1"></th>
            <th class="px-4 py-1"></th>
            <th class="px-4 py-1"></th>
            <th class="px-4 py-1"></th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-orange-600">B</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-sky-600">K</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-orange-600">B</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-sky-600">K</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-orange-600">B</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-sky-600">K</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-orange-600">B</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-sky-600">K</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-orange-600">B</th>
            <th class="px-2 py-1 text-center text-[10px] font-semibold text-sky-600">K</th>
            <th class="px-4 py-1"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-surface-100" id="menu-tbody">
          {menus.map((menu, idx) => (
            <tr class="hover:bg-surface-50 transition-colors" data-menu={menu.menuName}>
              <td class="px-4 py-3 text-surface-500 font-medium">{idx + 1}</td>
              <td class="px-4 py-3">
                {menu.imageUrl ? (
                  <img src={menu.imageUrl} alt={menu.menuName} class="w-16 h-16 object-cover rounded-xl border border-surface-200" />
                ) : (
                  <div class="w-16 h-16 bg-surface-100 rounded-xl border border-dashed border-surface-300 flex items-center justify-center">
                    <svg class="w-5 h-5 text-surface-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.41a2.25 2.25 0 013.182 0l2.909 2.91m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                    </svg>
                  </div>
                )}
              </td>
              <td class="px-4 py-3 font-bold text-surface-900 whitespace-nowrap">{menu.menuName}</td>
              <td class="px-4 py-3 max-w-[220px]">
                <div class="flex flex-wrap gap-1">
                  {menu.menuItems.map(item => (
                    <span class="text-[11px] font-medium text-brand-700 bg-brand-50 px-2 py-0.5 rounded-md">{item}</span>
                  ))}
                </div>
              </td>
              <td class="px-2 py-3 text-center font-semibold text-orange-600">{menu.porsi_besar.calories}</td>
              <td class="px-2 py-3 text-center text-sky-600">{menu.porsi_kecil.calories}</td>
              <td class="px-2 py-3 text-center font-semibold text-orange-600">{menu.porsi_besar.protein}</td>
              <td class="px-2 py-3 text-center text-sky-600">{menu.porsi_kecil.protein}</td>
              <td class="px-2 py-3 text-center font-semibold text-orange-600">{menu.porsi_besar.carbohydrates}</td>
              <td class="px-2 py-3 text-center text-sky-600">{menu.porsi_kecil.carbohydrates}</td>
              <td class="px-2 py-3 text-center font-semibold text-orange-600">{menu.porsi_besar.fat}</td>
              <td class="px-2 py-3 text-center text-sky-600">{menu.porsi_kecil.fat}</td>
              <td class="px-2 py-3 text-center font-semibold text-orange-600">{menu.porsi_besar.fiber}</td>
              <td class="px-2 py-3 text-center text-sky-600">{menu.porsi_kecil.fiber}</td>
              <td class="px-4 py-3 text-center">
                <button class="edit-btn text-brand-600 hover:text-brand-800 hover:bg-brand-50 p-1.5 rounded-lg transition-colors" data-menu={menu.menuName} title="Edit menu">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                  </svg>
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="edit-modal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="modal-overlay"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] overflow-y-auto overflow-hidden relative">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-brand-700 to-emerald-600 px-6 py-4 flex items-center justify-between">
          <h3 class="text-white font-bold text-[15px]" id="modal-title">Edit Menu</h3>
          <button id="modal-close" class="text-white/70 hover:text-white transition-colors">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <form id="edit-form" class="p-6 space-y-5">
          <input type="hidden" id="edit-menu-name" />

          <!-- Image Upload -->
          <div>
            <label class="block text-xs font-semibold text-surface-700 uppercase tracking-wide mb-2">Foto Menu</label>
            <div class="flex items-center gap-4">
              <div id="img-preview-wrap" class="w-20 h-20 rounded-xl border border-dashed border-surface-300 bg-surface-50 flex items-center justify-center overflow-hidden shrink-0">
                <img id="img-preview" class="w-full h-full object-cover hidden" alt="Preview" />
                <svg id="img-placeholder" class="w-6 h-6 text-surface-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.41a2.25 2.25 0 013.182 0l2.909 2.91m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                </svg>
              </div>
              <div class="flex-1">
                <label class="cursor-pointer inline-flex items-center gap-2 px-4 py-2 bg-brand-50 text-brand-700 rounded-xl text-xs font-semibold hover:bg-brand-100 transition-colors">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                  </svg>
                  Upload Foto
                  <input type="file" id="edit-image" accept="image/*" class="hidden" />
                </label>
                <p class="text-[10px] text-surface-400 mt-1">JPG, PNG. Maks 5MB</p>
              </div>
            </div>
          </div>

          <!-- Menu Items -->
          <div>
            <label class="block text-xs font-semibold text-surface-700 uppercase tracking-wide mb-2">Daftar Item Menu</label>
            <div id="items-container" class="space-y-2"></div>
            <button type="button" id="add-item-btn" class="mt-2 text-xs text-brand-600 hover:text-brand-800 font-semibold flex items-center gap-1 transition-colors">
              <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
              </svg>
              Tambah Item
            </button>
          </div>

          <!-- Nutrition Values -->
          <div>
            <label class="block text-xs font-semibold text-surface-700 uppercase tracking-wide mb-3">Nilai Gizi</label>
            <div class="grid grid-cols-2 gap-4">
              <!-- Porsi Besar -->
              <div class="space-y-2">
                <div class="flex items-center gap-1.5 mb-1">
                  <span class="w-2.5 h-2.5 rounded-full bg-orange-400"></span>
                  <span class="text-[11px] font-bold text-surface-600 uppercase tracking-wide">Porsi Besar</span>
                </div>
                <div class="space-y-1.5">
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Kalori</label>
                    <input type="number" step="any" id="nb-calories" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-orange-400 focus:ring-1 focus:ring-orange-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Protein</label>
                    <input type="number" step="any" id="nb-protein" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-orange-400 focus:ring-1 focus:ring-orange-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Karbo</label>
                    <input type="number" step="any" id="nb-carbohydrates" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-orange-400 focus:ring-1 focus:ring-orange-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Lemak</label>
                    <input type="number" step="any" id="nb-fat" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-orange-400 focus:ring-1 focus:ring-orange-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Serat</label>
                    <input type="number" step="any" id="nb-fiber" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-orange-400 focus:ring-1 focus:ring-orange-200 outline-none" />
                  </div>
                </div>
              </div>
              <!-- Porsi Kecil -->
              <div class="space-y-2 border-l border-surface-100 pl-4">
                <div class="flex items-center gap-1.5 mb-1">
                  <span class="w-2.5 h-2.5 rounded-full bg-sky-400"></span>
                  <span class="text-[11px] font-bold text-surface-600 uppercase tracking-wide">Porsi Kecil</span>
                </div>
                <div class="space-y-1.5">
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Kalori</label>
                    <input type="number" step="any" id="nk-calories" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-sky-400 focus:ring-1 focus:ring-sky-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Protein</label>
                    <input type="number" step="any" id="nk-protein" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-sky-400 focus:ring-1 focus:ring-sky-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Karbo</label>
                    <input type="number" step="any" id="nk-carbohydrates" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-sky-400 focus:ring-1 focus:ring-sky-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Lemak</label>
                    <input type="number" step="any" id="nk-fat" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-sky-400 focus:ring-1 focus:ring-sky-200 outline-none" />
                  </div>
                  <div class="flex items-center gap-2">
                    <label class="text-[11px] text-surface-500 w-14 shrink-0">Serat</label>
                    <input type="number" step="any" id="nk-fiber" class="nutri-input flex-1 px-2.5 py-1.5 text-xs border border-surface-200 rounded-lg focus:border-sky-400 focus:ring-1 focus:ring-sky-200 outline-none" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex items-center justify-end gap-3 pt-2 border-t border-surface-100">
            <button type="button" id="cancel-btn" class="px-4 py-2 text-xs font-semibold text-surface-500 hover:text-surface-700 transition-colors">Batal</button>
            <button type="submit" id="save-btn" class="px-5 py-2 bg-brand-600 text-white rounded-xl text-xs font-semibold hover:bg-brand-700 transition-colors flex items-center gap-2 disabled:opacity-50">
              <svg class="w-4 h-4 animate-spin hidden" id="save-spinner" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              <span id="save-text">Simpan</span>
            </button>
          </div>

          <!-- Status -->
          <div id="save-status" class="hidden text-xs text-center py-2 rounded-lg"></div>
        </form>
      </div>
    </div>
  </div>
</DashboardLayout>

<script define:vars={{ menusJson }}>
  const menus = JSON.parse(menusJson);

  // DOM refs
  const modal = document.getElementById('edit-modal');
  const overlay = document.getElementById('modal-overlay');
  const modalTitle = document.getElementById('modal-title');
  const modalClose = document.getElementById('modal-close');
  const cancelBtn = document.getElementById('cancel-btn');
  const editForm = document.getElementById('edit-form');
  const editMenuName = document.getElementById('edit-menu-name');
  const editImage = document.getElementById('edit-image');
  const imgPreview = document.getElementById('img-preview');
  const imgPlaceholder = document.getElementById('img-placeholder');
  const itemsContainer = document.getElementById('items-container');
  const addItemBtn = document.getElementById('add-item-btn');
  const saveBtn = document.getElementById('save-btn');
  const saveSpinner = document.getElementById('save-spinner');
  const saveText = document.getElementById('save-text');
  const saveStatus = document.getElementById('save-status');

  // Open modal
  function openModal(menuName) {
    const menu = menus.find(m => m.menuName === menuName);
    if (!menu) return;

    editMenuName.value = menuName;
    modalTitle.textContent = 'Edit ' + menuName;

    // Image preview
    if (menu.imageUrl) {
      imgPreview.src = menu.imageUrl;
      imgPreview.classList.remove('hidden');
      imgPlaceholder.classList.add('hidden');
    } else {
      imgPreview.classList.add('hidden');
      imgPlaceholder.classList.remove('hidden');
    }
    editImage.value = '';

    // Render item inputs
    renderItems(menu.menuItems);

    // Fill nutrition fields
    var keys = ['calories', 'protein', 'carbohydrates', 'fat', 'fiber'];
    keys.forEach(function(k) {
      document.getElementById('nb-' + k).value = menu.porsi_besar[k] || 0;
      document.getElementById('nk-' + k).value = menu.porsi_kecil[k] || 0;
    });

    // Reset status
    saveStatus.classList.add('hidden');

    modal.classList.remove('hidden');
  }

  function closeModal() {
    modal.classList.add('hidden');
  }

  function renderItems(items) {
    itemsContainer.innerHTML = '';
    items.forEach(function(item) { addItemInput(item); });
  }

  function addItemInput(value) {
    var div = document.createElement('div');
    div.className = 'flex items-center gap-2';

    var input = document.createElement('input');
    input.type = 'text';
    input.value = value || '';
    input.placeholder = 'Nama makanan';
    input.className = 'item-input flex-1 px-3 py-2 text-sm border border-surface-200 rounded-xl focus:border-brand-500 focus:ring-1 focus:ring-brand-200 outline-none transition-all';

    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-item text-surface-300 hover:text-red-500 transition-colors p-1';
    removeBtn.innerHTML = '<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>';
    removeBtn.addEventListener('click', function() {
      if (itemsContainer.children.length > 1) div.remove();
    });

    div.appendChild(input);
    div.appendChild(removeBtn);
    itemsContainer.appendChild(div);
  }

  // Image preview on file select
  editImage.addEventListener('change', function() {
    var file = editImage.files[0];
    if (file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        imgPreview.src = e.target.result;
        imgPreview.classList.remove('hidden');
        imgPlaceholder.classList.add('hidden');
      };
      reader.readAsDataURL(file);
    }
  });

  // Add item button
  addItemBtn.addEventListener('click', function() {
    addItemInput('');
    var inputs = itemsContainer.querySelectorAll('.item-input');
    inputs[inputs.length - 1].focus();
  });

  // Edit buttons
  document.querySelectorAll('.edit-btn').forEach(function(btn) {
    btn.addEventListener('click', function() { openModal(btn.dataset.menu); });
  });

  // Close modal
  overlay.addEventListener('click', closeModal);
  modalClose.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeModal();
  });

  // Save form
  editForm.addEventListener('submit', async function(e) {
    e.preventDefault();

    var menuName = editMenuName.value;
    var inputs = itemsContainer.querySelectorAll('.item-input');
    var items = Array.from(inputs).map(function(i) { return i.value.trim(); }).filter(function(v) { return v.length > 0; });

    if (items.length === 0) {
      showStatus('Minimal 1 item menu harus diisi', false);
      return;
    }

    saveBtn.disabled = true;
    saveSpinner.classList.remove('hidden');
    saveText.textContent = 'Menyimpan...';

    try {
      var fd = new FormData();
      fd.append('menuItems', JSON.stringify(items));

      // Nutrition values
      var nkeys = ['calories', 'protein', 'carbohydrates', 'fat', 'fiber'];
      var porsiBesar = {};
      var porsiKecil = {};
      nkeys.forEach(function(k) {
        porsiBesar[k] = parseFloat(document.getElementById('nb-' + k).value) || 0;
        porsiKecil[k] = parseFloat(document.getElementById('nk-' + k).value) || 0;
      });
      fd.append('porsiBesar', JSON.stringify(porsiBesar));
      fd.append('porsiKecil', JSON.stringify(porsiKecil));

      var file = editImage.files[0];
      if (file) {
        fd.append('image', file);
      }

      var res = await fetch('/api/menus/' + encodeURIComponent(menuName), {
        method: 'PUT',
        body: fd,
      });

      var data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || 'Gagal menyimpan');
      }

      showStatus('Berhasil disimpan! Halaman akan dimuat ulang...', true);
      setTimeout(function() { location.reload(); }, 1000);
    } catch (err) {
      showStatus(err.message || 'Terjadi kesalahan', false);
    } finally {
      saveBtn.disabled = false;
      saveSpinner.classList.add('hidden');
      saveText.textContent = 'Simpan';
    }
  });

  function showStatus(msg, success) {
    saveStatus.textContent = msg;
    saveStatus.className = 'text-xs text-center py-2 rounded-lg ' + (success ? 'bg-brand-50 text-brand-700' : 'bg-red-50 text-red-700');
    saveStatus.classList.remove('hidden');
  }
</script>
